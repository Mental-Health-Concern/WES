# Prepare scratch orgs
# Create and deploy managed packages to orgs so that they're ready to use with sfpowerscripts 

name: Prepare Scratch Orgs

on:
  workflow_dispatch:
    inputs:
      no_orgs_in_pool:
        description: 'Number of scratch orgs to prepare in the pool'
        required: true
        default: '5'

env:
  NO_ORGS_IN_POOL: ${{ github.event.inputs.no_orgs_in_pool }}
  POOL_NAME: 'CI_pool'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/setup-node@v1
      with:
        node-version: '10.x'

    - name: Install Salesforce CLI
      run: |
        npm install sfdx-cli
        node_modules/sfdx-cli/bin/run --version
        node_modules/sfdx-cli/bin/run plugins --core

    - name: Install sfpowerscripts
      run: |
        echo 'y' | sfdx plugins:install sfpowerkit
        echo 'y' | sfdx plugins:install sfdmu
        echo 'y' | sfdx plugins:install @dxatscale/sfpowerscripts

    - name: Check current contents of pool
      run: |
        sfdx sfpowerscripts:pool:list $POOL_NAME

    - name: Remove any orgs already in pool
      run: |
        sfdx sfpowerscripts:pool:delete -t $POOL_NAME
        echo "Cleared scratch org pool $POOL_NAME"

    - name: Create pool with required number of orgs
      run: |
        sfdx sfpowerscripts:orchestrator:prepare -t $POOL_NAME -m $NO_ORGS_IN_POOL
    
    - name: Check new contents of pool
      run: |
        sfdx sfpowerscripts:pool:list $POOL_NAME